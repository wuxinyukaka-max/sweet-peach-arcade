<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CANDY_WORM // åƒæ¡ƒå°è›‡</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- ç«–å±å¸ƒå±€æ ¸å¿ƒä¿®æ­£ --- */
        body {
            margin: 0; padding: 0;
            width: 100%; height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; /* å…¨å±å‚ç›´æ°´å¹³åŒé‡å±…ä¸­ */
            background-color: var(--bg-main);
            overflow: hidden;
            touch-action: none; /* ç¦æ­¢ç³»ç»Ÿæ‰‹åŠ¿ */
        }

        /* é¡¶éƒ¨çŠ¶æ€æ ï¼šè®¾ä¸ºç»å¯¹å®šä½ï¼Œä¸å ç”¨ä¸­å¿ƒå¯¹é½ç©ºé—´ */
        #hud {
            position: absolute; top: 20px; width: 100%;
            display: flex; justify-content: center;
            pointer-events: none; z-index: 100;
        }
        .score-box {
            background: white; padding: 8px 25px;
            border-radius: 20px; border: 2px solid var(--candy-pink);
            color: var(--candy-pink); font-size: 1rem; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .back-home { position: absolute; top: 20px; left: 20px; z-index: 110; }

        /* --- æ¸¸æˆç»„ä»¶ï¼šå°†ç”»å¸ƒå’Œæ‘‡æ†æ†ç»‘åœ¨ä¸€èµ·å±…ä¸­ --- */
        .game-capsule {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            gap: -30px; /* ç”»å¸ƒä¸æ‘‡æ†çš„é—´è· */
        }

        #canvas-wrap {
            height: auto !important;
            display: flex !important;
            justify-content: center;
        }

        canvas { 
            background: #EBE7E4; /* è«å…°è¿ªåº•è‰² */
            border: 6px solid white;
            border-radius: 35px;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.05);
            /* ç«–å±ä¼˜åŒ–æ¯”ä¾‹ï¼šå®½åº¦å å±å¹• 80% å·¦å³ï¼Œé«˜åº¦è‡ªé€‚åº” */
            max-height: 50vh; 
            max-width: 80vw;
            width: auto; height: auto;
            display: block;
        }

        /* æ§åˆ¶å™¨é¢æ¿ï¼šç´§è´´ç”»å¸ƒä¸‹æ–¹ */
        .controls {
            position: static !important; /* è¦†ç›–å…¨å±å®šä½ï¼Œè·Ÿéšæ–‡æ¡£æµ */
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: auto;
        }

        /* ç»“ç®—å¼¹çª—å®Œç¾å±…ä¸­ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(107, 94, 94, 0.2);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; backdrop-filter: blur(8px);
        }
    </style>
</head>
<body>
    <div class="candy-bg"></div>
    <a href="index.html" class="back-home" id="back-link">ğŸ  è¿”å›</a>

    <div id="hud">
        <div class="score-box">ğŸ‘ åƒæ¡ƒåˆ†æ•°: <span id="cur-score">0</span></div>
    </div>

    <!-- æ¸¸æˆæ ¸å¿ƒåŒ…ï¼šå— body å±…ä¸­æ§åˆ¶ -->
    <div class="game-capsule">
        <div id="canvas-wrap">
            <!-- çºµå‘æ¯”ä¾‹ç”»å¸ƒï¼š20x25 ä¸ªæ ¼å­ -->
            <canvas id="gameCanvas" width="400" height="500"></canvas>
        </div>

        <div class="controls">
            <div class="ctrl-panel">
                <div id="joy-base" class="joy-base">
                    <div id="joy-stick" class="joy-stick"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="over-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color: var(--candy-pink); font-size: 1.6rem; margin: 0 0 10px;">å“å‘€ï¼æ’ç¿»å•¦ ğŸ‘</h2>
            <p style="font-size: 0.95rem; color: #998888; margin-bottom: 25px;">æ”¶é›†äº† <span id="final-score" style="color:var(--candy-pink); font-weight:bold;">0</span> é¢—ç”œæ¡ƒ</p>
            <div class="cute-btn wide" onclick="handleReset()">å†æ¥ä¸€é¢—æ¡ƒï¼</div>
        </div>
    </div>

    <script>
        const CandyAudio = {
            ctx: null,
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (this.ctx.state === 'suspended') this.ctx.resume(); },
            playClick() { this.init(); const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type = 'sine'; o.frequency.setValueAtTime(800, this.ctx.currentTime); o.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.1); g.gain.setValueAtTime(0.2, this.ctx.currentTime); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime + 0.1); },
            playCollect() { this.init(); const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type = 'triangle'; o.frequency.setValueAtTime(400, this.ctx.currentTime); o.frequency.exponentialRampToValueAtTime(1200, this.ctx.currentTime + 0.2); g.gain.setValueAtTime(0.15, this.ctx.currentTime); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime + 0.2); },
            playGameOver() { this.init(); const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type = 'square'; o.frequency.setValueAtTime(300, this.ctx.currentTime); o.frequency.linearRampToValueAtTime(50, this.ctx.currentTime + 0.5); g.gain.setValueAtTime(0.1, this.ctx.currentTime); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime + 0.5); }
        };

        const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('cur-score'), modal = document.getElementById('over-modal'), finalEl = document.getElementById('final-score');

        // --- ç«–å±ç½‘æ ¼é…ç½® ---
        const GRID_SIZE = 20;
        const COLS = 20; // 400 / 20
        const ROWS = 25; // 500 / 20

        let snake, dir, food, score, isGameOver, lastTick = 0, joyX = 0, joyY = 0;

        function init() {
            snake = [{x: 10, y: 12}, {x: 10, y: 13}, {x: 10, y: 14}];
            dir = {x: 0, y: -1}; // åˆå§‹å‘ä¸Š
            score = 0; isGameOver = false;
            scoreEl.innerText = score;
            modal.style.display = 'none';
            spawnFood();
            requestAnimationFrame(loop);
        }

        function spawnFood() {
            food = { x: Math.floor(Math.random() * COLS), y: Math.floor(Math.random() * ROWS) };
            if (snake.some(s => s.x === food.x && s.y === food.y)) spawnFood();
        }

        const stick = document.getElementById('joy-stick'), base = document.getElementById('joy-base');
        let drag = false;
        const handleMove = (ex, ey) => {
            CandyAudio.init(); 
            const r = base.getBoundingClientRect(), cx = r.left + r.width/2, cy = r.top + r.height/2;
            let dx = ex - cx, dy = ey - cy;
            const d = Math.sqrt(dx*dx + dy*dy), m = 50;
            if(d > m) { dx *= m/d; dy *= m/d; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            joyX = dx/m; joyY = dy/m;
        };

        base.addEventListener('pointerdown', (e) => { drag = true; handleMove(e.clientX, e.clientY); });
        window.addEventListener('pointermove', e => { if(drag) handleMove(e.clientX, e.clientY); });
        window.addEventListener('pointerup', () => { drag = false; stick.style.transform = 'translate(0,0)'; joyX = 0; joyY = 0; });

        function loop(t) {
            if (isGameOver) return;
            requestAnimationFrame(loop);

            if (t - lastTick < 160) return;
            lastTick = t;

            if (Math.abs(joyX) > 0.5 && dir.x === 0) dir = { x: joyX > 0 ? 1 : -1, y: 0 };
            else if (Math.abs(joyY) > 0.5 && dir.y === 0) dir = { x: 0, y: joyY > 0 ? 1 : -1 };

            const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

            if (head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS || snake.some(s => s.x === head.x && s.y === head.y)) {
                isGameOver = true;
                CandyAudio.playGameOver(); 
                finalEl.innerText = score;
                modal.style.display = 'flex';
                return;
            }

            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                score++; scoreEl.innerText = score; 
                CandyAudio.playCollect(); 
                spawnFood();
            } else {
                snake.pop();
            }

            ctx.fillStyle = '#EBE7E4'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            snake.forEach((s, i) => {
                ctx.fillStyle = i === 0 ? '#D99FA9' : (i % 2 === 0 ? '#A1B5D0' : '#9BB7AD');
                ctx.beginPath(); ctx.arc(s.x * GRID_SIZE + 10, s.y * GRID_SIZE + 10, 8.5, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = 1.5; ctx.stroke();
            });
            ctx.font = "20px Arial"; ctx.fillText("ğŸ‘", food.x * GRID_SIZE + 1, food.y * GRID_SIZE + 17);
        }

        function handleReset() {
            CandyAudio.playClick(); 
            init();
        }

        init();
    </script>
</body>
</html>