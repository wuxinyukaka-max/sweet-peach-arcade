<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CANDY_WORM // åƒæ¡ƒå°è›‡</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ç§¯åˆ†æ˜¾ç¤ºç²¾è‡´åŒ– */
        #hud {
            position: absolute; top: 15px; width: 100%;
            display: flex; justify-content: center;
            pointer-events: none; z-index: 10;
        }
        .score-box {
            background: white; padding: 10px 25px;
            border-radius: 20px; border: 2px solid var(--candy-pink);
            color: var(--candy-pink); font-size: 1.1rem; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            letter-spacing: 1px;
        }

        /* æ¸¸æˆç»“æŸå¼¹çª— - å®Œç¾å±…ä¸­ä¸è«å…°è¿ªé…è‰² */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(107, 94, 94, 0.15); /* æŸ”å’Œçš„æ·±ç°è‰²é®ç½© */
            display: none; 
            align-items: center; 
            justify-content: center;
            z-index: 1000; 
            backdrop-filter: blur(10px);
        }
        .modal-content {
            background: white; 
            width: 85%; 
            max-width: 320px; 
            padding: 40px 30px; 
            border-radius: 40px;
            border: 1px solid rgba(255,255,255,0.5);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center;
            box-shadow: 0 25px 60px rgba(0,0,0,0.1);
        }

        #canvas-wrap { background: var(--bg-soft); }
        canvas { 
            background: #EBE7E4; /* åŒ¹é…è«å…°è¿ªç”»å¸ƒåº•è‰² */
            border: 8px solid white;
            border-radius: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div class="candy-bg"></div>
    <a href="index.html" class="back-home">ğŸ  è¿”å›å¤§å…</a>

    <div id="hud">
        <div class="score-box">ğŸ‘ é›†æ¡ƒåˆ†æ•°: <span id="cur-score">0</span></div>
    </div>

    <div id="canvas-wrap">
        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <!-- ç»“ç®—å¼¹çª— -->
    <div id="over-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color: var(--candy-pink); font-size: 1.6rem; margin: 0 0 10px;">å“å‘€ï¼æ’ç¿»å•¦ ğŸ‘</h2>
            <p style="font-size: 0.95rem; color: #998888; margin-bottom: 25px;">ä½ æ”¶é›†äº† <span id="final-score" style="color:var(--candy-pink); font-weight:bold;">0</span> é¢—ç”œæ¡ƒ</p>
            <div class="cute-btn wide" onclick="handleReset()">å†æ¥ä¸€é¢—æ¡ƒï¼</div>
        </div>
    </div>

    <!-- æ‘‡æ†ç»“æ„ -->
    <div class="controls">
        <div class="ctrl-panel">
            <div id="joy-base" class="joy-base">
                <div id="joy-stick" class="joy-stick"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ç³–æœéŸ³æ•ˆå¼•æ“ ---
        const CandyAudio = {
            ctx: null,
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            playClick() {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.1);
            },
            playCollect() {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, this.ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.2);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.2);
            },
            playGameOver() {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(300, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(50, this.ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.5);
            }
        };

        // --- 2. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ---
        const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('cur-score'), modal = document.getElementById('over-modal'), finalEl = document.getElementById('final-score');

        let snake, dir, food, score, isGameOver, lastTick = 0, joyX = 0, joyY = 0;

        function init() {
            snake = [{x: 10, y: 10}, {x: 9, y: 10}, {x: 8, y: 10}];
            dir = {x: 1, y: 0}; score = 0; isGameOver = false;
            scoreEl.innerText = score;
            modal.style.display = 'none';
            spawnFood();
            requestAnimationFrame(loop);
        }

        function spawnFood() {
            food = { x: Math.floor(Math.random() * 30), y: Math.floor(Math.random() * 20) };
            if (snake.some(s => s.x === food.x && s.y === food.y)) spawnFood();
        }

        // --- 3. æ‘‡æ†æ§åˆ¶é€»è¾‘ ---
        const stick = document.getElementById('joy-stick'), base = document.getElementById('joy-base');
        let drag = false;
        const handleMove = (ex, ey) => {
            CandyAudio.init(); 
            const r = base.getBoundingClientRect(), cx = r.left + r.width/2, cy = r.top + r.height/2;
            let dx = ex - cx, dy = ey - cy;
            const d = Math.sqrt(dx*dx + dy*dy), m = 50;
            if(d > m) { dx *= m/d; dy *= m/d; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            joyX = dx/m; joyY = dy/m;
        };

        base.onmousedown = () => drag = true;
        window.onmousemove = e => drag && handleMove(e.clientX, e.clientY);
        window.onmouseup = () => { drag = false; stick.style.transform = 'translate(0,0)'; joyX = 0; joyY = 0; };
        base.ontouchstart = e => { drag = true; handleMove(e.touches[0].clientX, e.touches[0].clientY); };
        base.ontouchmove = e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); };
        base.ontouchend = () => { drag = false; stick.style.transform = 'translate(0,0)'; joyX = 0; joyY = 0; };

        // --- 4. æ¸¸æˆå¾ªç¯ ---
        function loop(t) {
            if (isGameOver) return;
            requestAnimationFrame(loop);

            if (t - lastTick < 160) return;
            lastTick = t;

            if (Math.abs(joyX) > 0.5 && dir.x === 0) dir = { x: joyX > 0 ? 1 : -1, y: 0 };
            else if (Math.abs(joyY) > 0.5 && dir.y === 0) dir = { x: 0, y: joyY > 0 ? 1 : -1 };

            const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

            if (head.x < 0 || head.x >= 30 || head.y < 0 || head.y >= 20 || snake.some(s => s.x === head.x && s.y === head.y)) {
                isGameOver = true;
                CandyAudio.playGameOver(); 
                finalEl.innerText = score;
                modal.style.display = 'flex'; // è¿™é‡Œ display:flex ä¼šé…åˆ CSS å®ç°å®Œç¾å±…ä¸­
                return;
            }

            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                score++; scoreEl.innerText = score; 
                CandyAudio.playCollect(); 
                spawnFood();
            } else {
                snake.pop();
            }

            // --- æ ¸å¿ƒç»˜å›¾ä¼˜åŒ– ---
            ctx.fillStyle = '#EBE7E4'; // è«å…°è¿ªç”»å¸ƒåº•è‰²
            ctx.fillRect(0, 0, 600, 400);

            snake.forEach((s, i) => {
                // ä½¿ç”¨ä½é¥±å’Œè«å…°è¿ªè‰²ï¼šç°ç²‰ (#D99FA9)ã€æŸ”è“ (#A1B5D0)ã€é¼ å°¾è‰ç»¿ (#9BB7AD)
                ctx.fillStyle = i === 0 ? '#D99FA9' : (i % 2 === 0 ? '#A1B5D0' : '#9BB7AD');
                ctx.beginPath(); ctx.arc(s.x * 20 + 10, s.y * 20 + 10, 8.5, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = 1.5; ctx.stroke();
            });
            ctx.font = "20px Arial"; ctx.fillText("ğŸ‘", food.x * 20 + 2, food.y * 20 + 17);
        }

        function handleReset() {
            CandyAudio.playClick(); 
            setTimeout(() => init(), 100);
        }

        init();
    </script>
</body>
</html>