<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SWEET_MAZE // æ›²å¥‡è¿·å®«</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- 1. ç«–å±å±…ä¸­å¸ƒå±€ --- */
        body {
            margin: 0; padding: 0;
            width: 100%; height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background-color: var(--bg-main);
            overflow: hidden;
            touch-action: none;
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ  - ç»å¯¹å®šä½ */
        #hud {
            position: absolute; top: 20px; width: 100%;
            display: flex; justify-content: center;
            pointer-events: none; z-index: 100;
        }
        .timer-box {
            background: white; padding: 8px 25px;
            border-radius: 20px; border: 2.5px solid var(--candy-pink);
            color: var(--candy-pink); font-size: 1rem; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* æ¸¸æˆæ•´ä½“å®¹å™¨ */
        .game-capsule {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; gap: -30px;
        }

        #canvas-wrap {
            height: auto !important;
            display: flex !important;
            justify-content: center;
        }

        canvas { 
            background: #EBE7E4; /* è«å…°è¿ªåº•è‰² */
            border: 6px solid white;
            border-radius: 35px;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.05);
            /* ç«–å±ä¼˜åŒ–æ¯”ä¾‹ */
            max-height: 50vh; 
            max-width: 85vw;
            width: auto; height: auto;
            display: block;
        }

        /* æ§åˆ¶å™¨ï¼šè·Ÿéšæ–‡æ¡£æµ */
        .controls {
            position: static !important;
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: auto;
        }

        /* ç»“ç®—å¼¹çª— - å®Œç¾å±…ä¸­ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(107, 94, 94, 0.2);
            display: none; align-items: center; justify-content: center;
            z-index: 2000; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: white; width: 85%; max-width: 320px; padding: 40px 30px;
            border-radius: 45px; border: 1px solid rgba(255,255,255,0.5);
            display: flex; flex-direction: column; align-items: center; text-align: center;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.1);
        }
        .modal-content h2 { font-size: 1.6rem; color: var(--candy-pink); margin: 0 0 10px 0; }
        .modal-content p { font-size: 1rem; color: #998888; margin-bottom: 25px; }
        
        .back-home { position: absolute; top: 20px; left: 20px; z-index: 110; }
    </style>
</head>
<body>
    <div class="candy-bg"></div>
    <a href="index.html" class="back-home" id="back-link">ğŸ  æ”¾å¼ƒ</a>

    <div id="hud">
        <div class="timer-box">å‰©ä½™èƒ½é‡: <span id="time-left">60</span>s</div>
    </div>

    <!-- æ¸¸æˆæ ¸å¿ƒåŒ… -->
    <div class="game-capsule">
        <div id="canvas-wrap">
            <!-- çºµå‘æ¯”ä¾‹ï¼š21x25 ç½‘æ ¼ -->
            <canvas id="gameCanvas" width="420" height="500"></canvas>
        </div>

        <div class="controls">
            <div class="ctrl-panel">
                <div id="joy-base" class="joy-base">
                    <div id="joy-stick" class="joy-stick"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ç»“æ„ -->
    <div id="over-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">å“å‘€ï¼</h2>
            <p id="modal-desc">èƒ½é‡è€—å°½äº† ğŸ©</p>
            <button class="cute-btn wide" onclick="restartGame()">å†æ¥ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- 1. ç³–æœéŸ³æ•ˆå¼•æ“ ---
        const CandyAudio = {
            ctx: null,
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (this.ctx.state === 'suspended') this.ctx.resume(); },
            playClick() { this.init(); const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(800,this.ctx.currentTime); o.frequency.exponentialRampToValueAtTime(100,this.ctx.currentTime+0.1); g.gain.setValueAtTime(0.2,this.ctx.currentTime); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.1); },
            playCollect() { this.init(); const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(400,this.ctx.currentTime); o.frequency.exponentialRampToValueAtTime(1200,this.ctx.currentTime+0.2); g.gain.setValueAtTime(0.15,this.ctx.currentTime); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.2); },
            playGameOver() { this.init(); const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(300,this.ctx.currentTime); o.frequency.linearRampToValueAtTime(50,this.ctx.currentTime+0.5); g.gain.setValueAtTime(0.08,this.ctx.currentTime); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.5); }
        };

        // --- 2. æ¸¸æˆé…ç½® ---
        const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
        const timerEl = document.getElementById('time-left'), modal = document.getElementById('over-modal');

        const ROWS = 25; const COLS = 21; const CELL = 20;
        let grid, player, exit, timeLeft, isGameOver, joyX, joyY, timerInterval, lastMove = 0;

        function initGame() {
            grid = []; player = { x: 1, y: 1 }; exit = { x: COLS - 2, y: ROWS - 2 };
            timeLeft = 60; isGameOver = false; joyX = 0; joyY = 0;
            modal.style.display = 'none'; timerEl.innerText = timeLeft;
            genMaze(); startTimer(); requestAnimationFrame(loop);
        }

        function genMaze() {
            grid = Array(ROWS).fill().map(() => Array(COLS).fill(1));
            function walk(x, y) {
                grid[y][x] = 0;
                const dirs = [[0, -2], [0, 2], [-2, 0], [2, 0]].sort(() => Math.random() - 0.5);
                for (let [dx, dy] of dirs) {
                    let nx = x + dx, ny = y + dy;
                    if (nx > 0 && nx < COLS - 1 && ny > 0 && ny < ROWS - 1 && grid[ny][nx] === 1) {
                        grid[y + dy/2][x + dx/2] = 0; walk(nx, ny);
                    }
                }
            }
            walk(1, 1); grid[1][1] = 0; grid[exit.y][exit.x] = 0;
        }

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (isGameOver) return;
                timeLeft--; timerEl.innerText = timeLeft;
                if (timeLeft <= 0) endGame(false);
            }, 1000);
        }

        function endGame(win) {
            isGameOver = true; clearInterval(timerInterval);
            modal.style.display = 'flex';
            const title = document.getElementById('modal-title'), desc = document.getElementById('modal-desc');
            if (win) { CandyAudio.playCollect(); title.innerText = "å¥½æ£’ï¼ğŸ­"; desc.innerText = "æˆåŠŸæ‰¾åˆ°äº†ç³–æœç¤¼ç›’ï¼"; }
            else { CandyAudio.playGameOver(); title.innerText = "å‘œå‘œ...ğŸ©"; desc.innerText = "èƒ½é‡è€—å°½ï¼Œè¢«å›°åœ¨æ›²å¥‡é‡Œäº†"; }
        }

        function restartGame() { CandyAudio.playClick(); initGame(); }

        // --- 3. æ‘‡æ†æ§åˆ¶ ---
        const stick = document.getElementById('joy-stick'), base = document.getElementById('joy-base');
        let drag = false;
        const handleInput = (ex, ey) => {
            CandyAudio.init();
            const rect = base.getBoundingClientRect();
            let dx = ex - (rect.left + rect.width / 2), dy = ey - (rect.top + rect.height / 2);
            const d = Math.sqrt(dx * dx + dy * dy), m = 50;
            if (d > m) { dx *= m / d; dy *= m / d; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            joyX = dx / m; joyY = dy / m;
        };
        base.addEventListener('pointerdown', (e) => { drag = true; handleInput(e.clientX, e.clientY); });
        window.addEventListener('pointermove', (e) => { if (drag) handleInput(e.clientX, e.clientY); });
        window.addEventListener('pointerup', () => { drag = false; stick.style.transform = 'translate(0,0)'; joyX = 0; joyY = 0; });

        // --- 4. æ ¸å¿ƒå¾ªç¯ ---
        function loop(t) {
            if (isGameOver) return;
            requestAnimationFrame(loop);
            ctx.fillStyle = "#EBE7E4"; ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç”»å¢™å£ (è«å…°è¿ªç°æ£•)
            ctx.fillStyle = "#A89A90";
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (grid[y][x] === 1) drawRoundedRect(ctx, x * CELL + 1, y * CELL + 1, CELL - 2, CELL - 2, 5);
                }
            }
            // ç”»å‡ºå£
            ctx.font = "18px Arial"; ctx.fillText("ğŸ", exit.x * CELL + 1, exit.y * CELL + 17);

            // ç§»åŠ¨åˆ¤å®š
            if (t - lastMove > 120) {
                let nx = player.x, ny = player.y;
                if (Math.abs(joyX) > 0.4) nx += (joyX > 0 ? 1 : -1);
                else if (Math.abs(joyY) > 0.4) ny += (joyY > 0 ? 1 : -1);
                if (grid[ny] && grid[ny][nx] === 0) { player.x = nx; player.y = ny; lastMove = t; }
            }
            // ç”»ç©å®¶
            ctx.fillStyle = "#D99FA9"; ctx.beginPath(); ctx.arc(player.x * CELL + CELL/2, player.y * CELL + CELL/2, 8, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
            if (player.x === exit.x && player.y === exit.y) endGame(true);
        }

        function drawRoundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath(); ctx.moveTo(x+r, y); ctx.lineTo(x+w-r, y); ctx.quadraticCurveTo(x+w, y, x+w, y+r); ctx.lineTo(x+w, y+h-r); ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h); ctx.lineTo(x+r, y+h); ctx.quadraticCurveTo(x, y+h, x, y+h-r); ctx.lineTo(x, y+r); ctx.quadraticCurveTo(x, y, x+r, y); ctx.closePath(); ctx.fill();
        }

        initGame();
    </script>
</body>
</html>