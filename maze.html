<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>SWEET_MAZE // è«å…°è¿ªä¸€æ’å¼æ§åˆ¶ç‰ˆ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--bg-main); overflow: hidden;
            touch-action: none;
        }

        #game-container {
            position: relative;
            display: flex; align-items: center; justify-content: center;
            width: 100%; height: 100%;
        }

        canvas {
            background: #EBE7E4;
            border: 6px solid white;
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            max-width: 95vw;
            max-height: 94vh;
            width: auto; height: auto;
            display: block;
        }

        /* éšè—æ—§ç»„ä»¶ */
        #hud, .controls, .button-panel { display: none !important; }
        .back-home { position: absolute; top: 20px; left: 20px; z-index: 1000; font-weight: bold; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(107, 94, 94, 0.3);
            display: none; align-items: center; justify-content: center;
            z-index: 2000; backdrop-filter: blur(10px);
        }
        .modal-content {
            background: white; width: 80%; max-width: 300px; padding: 30px;
            border-radius: 40px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="candy-bg"></div>
    <a href="index.html" class="back-home" id="back-link">ğŸ  è¿”å›</a>

    <div id="game-container">
        <!-- 400x800 ä¸€ä½“åŒ–æ¯”ä¾‹ -->
        <canvas id="gameCanvas" width="400" height="800"></canvas>
    </div>

    <div id="over-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" style="color: var(--candy-pink); margin-bottom: 5px; font-size: 1.5rem;">èƒ½é‡è€—å°½ ğŸ©</h2>
            <p id="modal-desc" style="color: #998888; font-size: 0.9rem; margin-bottom: 25px;">è¿·å®«å¤ªå¤æ‚äº†...</p>
            <button class="cute-btn wide" onclick="handleReset()" style="width: 100%; height: 50px; border-radius: 25px; font-size: 1rem;">é‡ç½®èƒ½é‡</button>
        </div>
    </div>

    <script>
        // --- 1. ç³–æœéŸ³æ•ˆå¼•æ“ ---
        const CandyAudio = {
            ctx: null,
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (this.ctx.state === 'suspended') this.ctx.resume(); },
            play(type) {
                this.init(); const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination);
                const n = this.ctx.currentTime;
                if(type==='click'){ o.frequency.setValueAtTime(800,n); o.frequency.exponentialRampToValueAtTime(100,n+0.1); g.gain.setValueAtTime(0.12,n); }
                if(type==='ding'){ o.type='triangle'; o.frequency.setValueAtTime(400,n); o.frequency.exponentialRampToValueAtTime(1200,n+0.2); g.gain.setValueAtTime(0.1,n); }
                if(type==='sad'){ o.type='square'; o.frequency.setValueAtTime(200,n); o.frequency.linearRampToValueAtTime(50,n+0.5); g.gain.setValueAtTime(0.08,n); }
                o.start(); o.stop(n + 0.5);
            }
        };

        // --- 2. æ ¸å¿ƒé…ç½®ï¼šæœ€å¤§åŒ–è¿·å®«åŒºåŸŸ ---
        const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
        const modal = document.getElementById('over-modal');

        const COLS = 31; 
        const ROWS = 51; // æå¤§åŒ–è¿·å®«é«˜åº¦
        const CELL = 12; 
        const GAME_X_OFFSET = 14; 
        const GAME_Y_OFFSET = 80; // é¡¶éƒ¨è®¡æ—¶å™¨ä¸‹æ–¹å³å¼€å§‹

        let grid, player, exit, timeLeft, isGameOver, timerInterval;
        let activeMoveDir = null; 
        let lastMoveTimestamp = 0;
        const MOVE_INTERVAL = 80; // è¿›ä¸€æ­¥åŠ å¿«è¿ç»­ç§»åŠ¨é€Ÿåº¦

        // ä¸€æ’å¼æŒ‰é’®å®šä¹‰ï¼šæŒ‰é¡ºåº å·¦ã€å³ã€ä¸Šã€ä¸‹
        const uiBtns = {
            L: { x: 25,  y: 710, w: 80, h: 70, icon: 'â¬…', move: {x: -1, y: 0}, color: '#9BB7AD' },
            R: { x: 295, y: 710, w: 80, h: 70, icon: 'â¡', move: {x: 1, y: 0}, color: '#9BB7AD' },
            U: { x: 115, y: 710, w: 80, h: 70, icon: 'â¬†', move: {x: 0, y: -1}, color: '#D99FA9' },
            D: { x: 205, y: 710, w: 80, h: 70, icon: 'â¬‡', move: {x: 0, y: 1}, color: '#D99FA9' }
        };

        function init() {
            grid = []; player = { x: 1, y: 1 }; exit = { x: COLS - 2, y: ROWS - 2 };
            timeLeft = 60; isGameOver = false; activeMoveDir = null;
            modal.style.display = 'none';
            genMaze();
            startTimer();
            requestAnimationFrame(loop);
        }

        function genMaze() {
            grid = Array(ROWS).fill().map(() => Array(COLS).fill(1));
            function walk(x, y) {
                grid[y][x] = 0;
                const d = [[0, -2], [0, 2], [-2, 0], [2, 0]].sort(() => Math.random() - 0.5);
                for (let [dx, dy] of d) {
                    let nx = x + dx, ny = y + dy;
                    if (nx > 0 && nx < COLS - 1 && ny > 0 && ny < ROWS - 1 && grid[ny][nx] === 1) {
                        grid[y + dy / 2][x + dx / 2] = 0; walk(nx, ny);
                    }
                }
            }
            walk(1, 1);
            grid[ROWS-2][COLS-2] = 0;
        }

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (isGameOver) return;
                timeLeft--;
                if (timeLeft <= 0) endGame(false);
                draw();
            }, 1000);
        }

        function getTouchPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const t = e.touches ? e.touches[0] : e;
            return { x: (t.clientX - rect.left) * scaleX, y: (t.clientY - rect.top) * scaleY };
        }

        canvas.addEventListener('pointerdown', (e) => {
            e.preventDefault(); CandyAudio.init();
            if (isGameOver) return;
            const pos = getTouchPos(e);
            for (let k in uiBtns) {
                let btn = uiBtns[k];
                if (pos.x > btn.x && pos.x < btn.x + btn.w && pos.y > btn.y && pos.y < btn.y + btn.h) {
                    btn.active = true;
                    activeMoveDir = btn.move;
                    CandyAudio.play('click');
                }
            }
        });

        const stopMove = () => { for (let k in uiBtns) uiBtns[k].active = false; activeMoveDir = null; };
        window.addEventListener('pointerup', stopMove);
        window.addEventListener('pointercancel', stopMove);

        function loop(timestamp) {
            if (isGameOver) return;
            if (activeMoveDir) {
                if (timestamp - lastMoveTimestamp > MOVE_INTERVAL) {
                    let nx = player.x + activeMoveDir.x, ny = player.y + activeMoveDir.y;
                    if (grid[ny] && grid[ny][nx] === 0) {
                        player.x = nx; player.y = ny;
                        if (player.x === exit.x && player.y === exit.y) endGame(true);
                    }
                    lastMoveTimestamp = timestamp;
                }
            }
            draw();
            requestAnimationFrame(loop);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. é¡¶éƒ¨ HUD
            ctx.fillStyle = "rgba(255,255,255,0.9)";
            drawRoundedRect(ctx, 110, 20, 180, 40, 20);
            ctx.fillStyle = timeLeft < 10 ? "#FF85A1" : "#9BB7AD";
            ctx.font = "bold 18px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(`ENERGY: ${timeLeft}s`, 200, 40);

            // 2. è¿·å®«ç»˜åˆ¶åŒº (ç´§å‡‘å¡«å……)
            ctx.fillStyle = "rgba(255,255,255,0.4)";
            drawRoundedRect(ctx, GAME_X_OFFSET-4, GAME_Y_OFFSET-4, (COLS*CELL)+8, (ROWS*CELL)+8, 12);
            
            ctx.fillStyle = "#A89A90";
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (grid[y][x] === 1) drawRoundedRect(ctx, GAME_X_OFFSET + x * CELL + 1, GAME_Y_OFFSET + y * CELL + 1, CELL - 2, CELL - 2, 3);
                }
            }

            // 3. å‡ºå£
            ctx.font = "12px Arial";
            ctx.fillText("ğŸ", GAME_X_OFFSET + exit.x * CELL + 6, GAME_Y_OFFSET + exit.y * CELL + 6);

            // 4. ç©å®¶çç 
            ctx.fillStyle = "#D99FA9";
            ctx.beginPath();
            ctx.arc(GAME_X_OFFSET + player.x * CELL + 6, GAME_Y_OFFSET + player.y * CELL + 6, 4.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "white"; ctx.lineWidth = 1; ctx.stroke();

            // 5. åº•éƒ¨ä¸€æ’å¼æŒ‰é’®
            ctx.textBaseline = "alphabetic";
            for (let k in uiBtns) {
                let btn = uiBtns[k];
                ctx.save();
                ctx.fillStyle = btn.active ? "rgba(217, 159, 169, 0.9)" : "rgba(255,255,255,0.7)";
                ctx.strokeStyle = "white";
                ctx.lineWidth = 4;
                drawRoundedRect(ctx, btn.x, btn.y, btn.w, btn.h, 18);
                ctx.stroke();
                ctx.fillStyle = btn.active ? "white" : btn.color;
                ctx.font = "bold 32px Arial";
                ctx.textAlign = "center";
                ctx.fillText(btn.icon, btn.x + btn.w/2, btn.y + btn.h/2 + 12);
                ctx.restore();
            }
        }

        function endGame(win) {
            isGameOver = true;
            clearInterval(timerInterval);
            const title = document.getElementById('modal-title'), desc = document.getElementById('modal-desc');
            if (win) { CandyAudio.play('ding'); title.innerText = "æŒ‘æˆ˜æˆåŠŸï¼ğŸ­"; desc.innerText = `ä½ æ˜¯è¿·å®«å¤§å¸ˆï¼å‰©ä½™èƒ½é‡: ${timeLeft}s`; }
            else { CandyAudio.play('sad'); title.innerText = "å¯æƒœï¼ğŸ©"; desc.innerText = "ç¦»å‡ºå£åªå·®ä¸€ç‚¹ç‚¹..."; }
            modal.style.display = 'flex';
        }

        function handleReset() { CandyAudio.play('click'); init(); }

        function drawRoundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); ctx.fill();
        }

        init();
    </script>
</body>
</html>