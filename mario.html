<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CAKE_JUMP // ç³–æœå¤§å†’é™©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- ç«–å±é€‚é…æ ¸å¿ƒå¸ƒå±€ --- */
        body {
            margin: 0; padding: 0; width: 100%; height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: var(--bg-main); overflow: hidden; touch-action: manipulation;
        }

        #hud {
            position: absolute; top: 15px; width: 100%;
            display: flex; justify-content: center; pointer-events: none; z-index: 10;
        }
        .info-box {
            background: white; padding: 8px 18px; border-radius: 20px;
            border: 2.5px solid var(--candy-pink); color: var(--candy-pink);
            font-size: 0.9rem; font-weight: bold; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin: 0 5px;
        }

        .game-capsule { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; gap: -30px; }
        
        canvas { 
            background: #EBE7E4; border: 6px solid white; border-radius: 35px;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.05);
            max-height: 55vh; max-width: 85vw; width: auto; height: auto;
        }

        .controls { position: static !important; display: flex; justify-content: center; gap: 15px; padding: 10px; pointer-events: auto; }

        /* å¼¹çª—å±…ä¸­ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(107, 94, 94, 0.2); display: none; 
            align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: white; width: 85%; max-width: 320px; padding: 35px 25px;
            border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex; flex-direction: column; align-items: center; text-align: center;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="candy-bg"></div>
    <a href="index.html" class="back-home" style="position:absolute; top:20px; left:20px; z-index:110;">ğŸ  è¿”å›</a>

    <div id="hud">
        <div class="info-box">â­æ˜Ÿæ˜Ÿ: <span id="score">0</span></div>
        <div class="info-box">ğŸš©è·ç¦»: <span id="dist">0</span>m</div>
    </div>

    <div class="game-capsule">
        <div id="canvas-wrap">
            <canvas id="gameCanvas" width="400" height="600"></canvas>
        </div>

        <div class="controls">
            <div class="ctrl-panel">
                <div class="cute-btn btn-mint" id="btn-left">â†</div>
                <div class="cute-btn btn-mint" id="btn-right">â†’</div>
            </div>
            <div class="ctrl-panel">
                <div class="cute-btn" id="btn-jump">â†‘</div>
                <div class="cute-btn btn-mint" id="btn-down">â†“</div>
            </div>
        </div>
    </div>

    <div id="over-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="result-title" style="color:var(--candy-pink); margin:0;">å“å‘€ï¼</h2>
            <p id="result-desc" style="color:#998888; margin:15px 0 25px;"></p>
            <button class="cute-btn wide" onclick="resetGame()" style="width:200px; height:55px; border-radius:30px;">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <script>
        // --- 1. ç³–æœéŸ³æ•ˆå¼•æ“ ---
        const CandyAudio = {
            ctx: null,
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (this.ctx.state === 'suspended') this.ctx.resume(); },
            play(type) {
                this.init(); const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination);
                const n = this.ctx.currentTime;
                if(type==='jump'){ o.type='sine'; o.frequency.setValueAtTime(150,n); o.frequency.exponentialRampToValueAtTime(600,n+0.2); g.gain.setValueAtTime(0.1,n); }
                if(type==='star'){ o.type='triangle'; o.frequency.setValueAtTime(600,n); o.frequency.exponentialRampToValueAtTime(1200,n+0.1); g.gain.setValueAtTime(0.1,n); }
                if(type==='break'){ o.type='square'; o.frequency.setValueAtTime(100,n); o.frequency.linearRampToValueAtTime(10,n+0.1); g.gain.setValueAtTime(0.05,n); }
                if(type==='dead'){ o.type='square'; o.frequency.setValueAtTime(200,n); o.frequency.linearRampToValueAtTime(50,n+0.5); g.gain.setValueAtTime(0.1,n); }
                o.start(); o.stop(n+0.5);
            }
        };

        // --- 2. æ¸¸æˆå¼•æ“é€»è¾‘ ---
        const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score'), distEl = document.getElementById('dist'), modal = document.getElementById('over-modal');

        const GRAVITY = 0.8, JUMP_FORCE = -15, SPEED = 5, MAP_LENGTH = 12000; // åœ°å›¾å¤§å¹…å»¶é•¿
        let player, platforms, cameraX, score, isGameOver, keys = { left: false, right: false }, animationId = null;

        function init() {
            if (animationId) cancelAnimationFrame(animationId);
            // ä¿®æ­£ï¼šç©å®¶ç”Ÿæˆä½ç½®åœ¨ç¬¬ä¸€å—åœ°é¢çš„æ­£ä¸Šæ–¹
            player = { x: 100, y: 300, w: 32, h: 32, vx: 0, vy: 0, grounded: false };
            score = 0; cameraX = 0; isGameOver = false; keys = { left: false, right: false };
            scoreEl.innerText = score; distEl.innerText = 0; modal.style.display = 'none';
            generateMap();
            loop();
        }

        function generateMap() {
            // èµ·å§‹å¹³å°å˜é•¿ï¼Œé˜²æ­¢å¼€å±€æ‰è½
            platforms = [{ x: 0, y: 480, w: 600, h: 120, type: 'ground', active: true }];
            let cx = 650;
            while (cx < MAP_LENGTH) {
                let w = 80 + Math.random() * 120;
                let lastP = platforms[platforms.length - 1];
                // çœŸæ­£çš„ä¸Šä¸‹å¤šå±‚çº§ï¼šY è½´è·¨åº¦åŠ å¤§
                let y = Math.max(120, Math.min(500, lastP.y + (Math.random() * 240 - 120)));
                
                let rand = Math.random();
                let type = 'cookie';
                if(rand > 0.85) type = 'brick';     // å¯é¡¶ç¢
                else if(rand > 0.7) type = 'mystery'; // è—æ˜Ÿæ˜Ÿ
                
                platforms.push({ x: cx, y: y, w: w, h: 32, type: type, active: true });
                cx += w + 70 + Math.random() * 100;
            }
            // è¿œæ–¹çš„ç»ˆç‚¹
            platforms.push({ x: MAP_LENGTH, y: 400, w: 500, h: 200, type: 'end', active: true });
        }

        // --- 3. ç‰©ç†ä¸ç¢°æ’ ---
        function update() {
            if (keys.left) player.vx = -SPEED; else if (keys.right) player.vx = SPEED; else player.vx *= 0.85;
            player.vy += GRAVITY; player.x += player.vx; player.y += player.vy;
            player.grounded = false;

            platforms.forEach(p => {
                if (!p.active && p.type !== 'mystery_used') return;
                
                // ç¢°æ’æ£€æµ‹é€»è¾‘
                if (player.x + player.w > p.x && player.x < p.x + p.w &&
                    player.y + player.h > p.y && player.y < p.y + p.h) {
                    
                    // 1. è„šéƒ¨ç¢°æ’ï¼ˆè½åœ°ï¼‰
                    if (player.vy > 0 && player.y + player.h < p.y + p.h/2 + player.vy + 2) {
                        player.y = p.y - player.h; player.vy = 0; player.grounded = true;
                        if (p.type === 'end') win();
                    } 
                    // 2. å¤´éƒ¨ç¢°æ’ï¼ˆé¡¶ç –å—ï¼‰
                    else if (player.vy < 0 && player.y > p.y + p.h/2) {
                        player.y = p.y + p.h; player.vy = 1; // æ’å¤´åå‘ä¸‹å¼¹
                        handleBlockHit(p);
                    }
                    // 3. ä¾§é¢ç¢°æ’
                    else if (player.x + player.w > p.x && player.x < p.x + p.w) {
                        player.x -= player.vx; player.vx = 0;
                    }
                }
            });

            // æ‘„åƒæœºè·Ÿéš
            cameraX = Math.max(cameraX, player.x - 100);
            distEl.innerText = Math.floor(player.x / 10);

            // æ­»äº¡é€»è¾‘
            if (player.y > 650) endGame("æ‰è¿›å¥¶æ²¹æ± äº†ï¼ğŸ©", "åˆ«ç°å¿ƒï¼Œå†è¯•ä¸€æ¬¡ï¼");
            if (player.x < cameraX - 10) player.x = cameraX - 10;
        }

        function handleBlockHit(p) {
            if (p.type === 'brick') {
                p.active = false; CandyAudio.play('break');
            } else if (p.type === 'mystery') {
                p.type = 'mystery_used';
                score += 5; scoreEl.innerText = score;
                CandyAudio.play('star');
            }
        }

        // --- 4. ç»˜å›¾ä¸ç¾æ•ˆ ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.translate(-cameraX, 0);

            platforms.forEach(p => {
                if (!p.active && p.type !== 'mystery_used') return;
                
                if (p.type === 'end') {
                    ctx.fillStyle = "#D99FA9"; drawRoundedRect(ctx, p.x, p.y, p.w, p.h, 30);
                    ctx.font = "50px Arial"; ctx.fillText("ğŸ‚", p.x + p.w/2 - 25, p.y - 20);
                } else {
                    // è«å…°è¿ªé…è‰²æ–¹æ¡ˆ
                    if(p.type === 'brick') ctx.fillStyle = "#E6D5B8"; // å¨åŒ–è‰²
                    else if(p.type === 'mystery') ctx.fillStyle = "#FFB6C1"; // ç¤¼ç›’è‰²
                    else if(p.type === 'mystery_used') ctx.fillStyle = "#D1C7C7"; // å¤±æ•ˆç°è‰²
                    else ctx.fillStyle = p.type === 'ground' ? "#A89A90" : "#9BB7AD";
                    
                    drawRoundedRect(ctx, p.x, p.y, p.w, p.h, 10);
                    // ç»˜åˆ¶æ˜Ÿæ˜Ÿæ ‡è¯†ï¼ˆå¦‚æœæ˜¯éšè—ç –å—ï¼‰
                    if(p.type === 'mystery') drawJellyStar(ctx, p.x + p.w/2, p.y + 16, 8, true);
                }
            });

            // ç»˜åˆ¶ç©å®¶ (è‰è“é…±å—)
            ctx.fillStyle = "#D99FA9"; drawRoundedRect(ctx, player.x, player.y, player.w, player.h, 10);
            ctx.fillStyle = "white"; ctx.fillRect(player.x+22, player.y+6, 4, 4); ctx.fillRect(player.x+6, player.y+6, 4, 4);
            ctx.fillStyle = "rgba(255,255,255,0.3)"; ctx.beginPath(); ctx.ellipse(player.x+10, player.y+10, 7, 4, Math.PI/4, 0, 7); ctx.fill();

            ctx.restore();
        }

        // é«˜çº§é‡‘é»„è‰²æœå†»æ˜Ÿç»˜åˆ¶å‡½æ•°
        function drawJellyStar(ctx, x, y, r, isMini = false) {
            ctx.save(); ctx.translate(x, y); ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                ctx.lineTo(Math.cos((18 + i * 72) / 180 * Math.PI) * r, -Math.sin((18 + i * 72) / 180 * Math.PI) * r);
                ctx.lineTo(Math.cos((54 + i * 72) / 180 * Math.PI) * (r/2.2), -Math.sin((54 + i * 72) / 180 * Math.PI) * (r/2.2));
            }
            ctx.closePath();
            let g = ctx.createRadialGradient(0, 0, 0, 0, 0, r);
            g.addColorStop(0, '#F7DC6F'); g.addColorStop(1, '#D4AC0D');
            ctx.fillStyle = g; ctx.fill();
            if(!isMini){ // å¤§æ˜Ÿæ˜Ÿæœ‰é«˜å…‰
                ctx.strokeStyle = "white"; ctx.lineWidth = 1; ctx.stroke();
                ctx.fillStyle = "rgba(255, 255, 255, 0.6)"; ctx.beginPath(); ctx.ellipse(-r/3, -r/3, r/4, r/8, Math.PI/4, 0, 7); ctx.fill();
            }
            ctx.restore();
        }

        // --- 5. äº¤äº’ç»‘å®š ---
        const bind = (id, key) => {
            const el = document.getElementById(id);
            el.addEventListener('pointerdown', (e) => { 
                e.preventDefault(); CandyAudio.init();
                if(key==='jump') { if(player.grounded){ player.vy = JUMP_FORCE; player.grounded = false; CandyAudio.play('jump'); } } 
                else keys[key] = true;
            });
            window.addEventListener('pointerup', () => keys[key] = false);
        };
        bind('btn-left', 'left'); bind('btn-right', 'right'); bind('btn-jump', 'jump');

        function loop() { if (!isGameOver) { update(); draw(); animationId = requestAnimationFrame(loop); } }
        function win() { CandyAudio.play('star'); endGame("ç¾å‘³åˆ°è¾¾ï¼ğŸ‰", "ä½ æˆåŠŸæ‹¿åˆ°äº†ç»ˆæå¤§è›‹ç³•ï¼æ˜Ÿæ˜Ÿ: " + score); }
        function endGame(t, d) { isGameOver = true; CandyAudio.play('dead'); modal.style.display = 'flex'; document.getElementById('result-title').innerText = t; document.getElementById('result-desc').innerText = d; }
        function resetGame() { CandyAudio.init(); init(); }
        function drawRoundedRect(ctx, x, y, w, h, r) { ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); ctx.fill(); }

        init();
    </script>
</body>
</html>