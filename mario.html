<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAKE_JUMP // ç³–æœå¤§å†’é™©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* HUDç²¾è‡´åŒ– */
        #hud {
            position: absolute; top: 15px; width: 100%;
            display: flex; justify-content: center;
            pointer-events: none; z-index: 10;
        }
        .info-box {
            background: white; padding: 8px 20px;
            border-radius: 20px; border: 3px solid var(--candy-pink);
            color: var(--candy-pink); font-size: 1rem; font-weight: bold;
            box-shadow: 0 4px 0px rgba(255, 133, 161, 0.1);
            margin: 0 8px;
        }

        /* ç»“ç®—å¼¹çª— - æ·±åº¦ç¾åŒ–ä¸å®Œç¾å±…ä¸­ */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            display: none; /* ç”±JSæ§åˆ¶æ˜¾ç¤º */
            align-items: center; justify-content: center;
            z-index: 1000; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: white; width: 85%; max-width: 340px; 
            padding: 40px 30px; border-radius: 45px;
            border: 6px solid var(--candy-mint);
            display: flex; flex-direction: column;
            align-items: center; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.08);
        }
        .modal-content h2 { 
            font-size: 1.8rem; color: var(--candy-pink); 
            margin: 0 0 10px 0; letter-spacing: -0.5px;
        }
        .modal-content p { 
            font-size: 1rem; color: #998888; 
            margin: 0 0 30px 0; line-height: 1.5;
        }

        #canvas-wrap { background: var(--bg-soft); }
        canvas { 
            background: #EBE7E4; /* åŒ¹é…è«å…°è¿ªç”»å¸ƒåº•è‰² */
            border: 8px solid white;
            border-radius: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div class="candy-bg"></div>
    <a href="index.html" class="back-home" id="back-link">ğŸ  è¿”å›</a>

    <div id="hud">
        <div class="info-box">â­ æ˜Ÿæ˜Ÿ: <span id="score">0</span></div>
        <div class="info-box">ğŸš© è·ç¦»: <span id="dist">0</span>m</div>
    </div>

    <div id="canvas-wrap">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
    </div>

    <!-- é‡æ–°è®¾è®¡çš„å¼¹çª—ç»“æ„ -->
    <div id="over-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="result-title">å“å‘€ï¼</h2>
            <p id="result-desc"></p>
            <button class="cute-btn wide" onclick="resetGame()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <!-- æ§åˆ¶å™¨ï¼šå…¨éƒ¨ä½¿ç”¨ç¬¦å· -->
    <div class="controls">
        <div class="ctrl-panel">
            <div class="cute-btn btn-mint" id="btn-left">â—€</div>
            <div class="cute-btn btn-mint" id="btn-right">â–¶</div>
        </div>
        <div class="ctrl-panel">
            <div class="cute-btn" id="btn-jump">â–²</div>
            <div class="cute-btn btn-mint" id="btn-down">â–¼</div>
        </div>
    </div>

    <script>
        // --- 1. ç³–æœéŸ³æ•ˆå¼•æ“ ---
        const CandyAudio = {
            ctx: null,
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            playClick() {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.1);
            },
            playCollect() {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, this.ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.2);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.2);
            },
            playGameOver() {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(300, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(50, this.ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.5);
            },
            playJump() {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, this.ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.2);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.2);
            }
        };

        // --- 2. æ¸¸æˆé€»è¾‘ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const distEl = document.getElementById('dist');
        const modal = document.getElementById('over-modal');

        const GRAVITY = 0.8;
        const JUMP_FORCE = -16;
        const SPEED = 6;
        const MAP_LENGTH = 4000;

        let player, platforms, items, cameraX, score, isGameOver;
        let keys = { left: false, right: false };
        let animationId = null;

        function init() {
            if (animationId) cancelAnimationFrame(animationId);
            isGameOver = false;
            score = 0;
            cameraX = 0;
            keys = { left: false, right: false };
            
            player = { x: 100, y: 200, w: 35, h: 35, vx: 0, vy: 0, grounded: false };

            scoreEl.innerText = score;
            distEl.innerText = 0;
            modal.style.display = 'none';

            generateMap();
            loop();
        }

        function generateMap() {
            platforms = [{ x: 0, y: 350, w: 400, h: 50, type: 'ground' }];
            items = [];
            let currentX = 450;
            while (currentX < MAP_LENGTH - 400) {
                let w = 100 + Math.random() * 150;
                let lastY = platforms[platforms.length - 1].y;
                let y = Math.max(150, Math.min(350, lastY + (Math.random() * 200 - 100)));
                platforms.push({ x: currentX, y: y, w: w, h: 20, type: 'cookie' });
                if (Math.random() > 0.5) items.push({ x: currentX + w/2, y: y - 50, collected: false });
                currentX += w + 80 + Math.random() * 100;
            }
            platforms.push({ x: MAP_LENGTH - 300, y: 320, w: 300, h: 80, type: 'end' });
        }

        // --- æ§åˆ¶ç»‘å®š ---
        const bind = (id, key) => {
            const el = document.getElementById(id);
            const start = (e) => { 
                e.preventDefault(); 
                CandyAudio.init(); // æ¿€æ´»éŸ³é¢‘
                if(isGameOver) return;
                if(key==='jump') doJump(); else keys[key] = true; 
            };
            const end = (e) => { keys[key] = false; };
            el.addEventListener('mousedown', start);
            el.addEventListener('touchstart', start);
            window.addEventListener('mouseup', end);
            window.addEventListener('touchend', end);
        };
        bind('btn-left', 'left'); bind('btn-right', 'right'); bind('btn-jump', 'jump');

        document.getElementById('back-link').addEventListener('click', () => CandyAudio.playClick());

        function doJump() {
            if (player.grounded) { 
                player.vy = JUMP_FORCE; 
                player.grounded = false; 
                CandyAudio.playJump(); // è§¦å‘è·³è·ƒéŸ³æ•ˆ
            }
        }

        function loop() {
            if (isGameOver) return;
            update();
            draw();
            animationId = requestAnimationFrame(loop);
        }

        function update() {
            if (keys.left) player.vx = -SPEED;
            else if (keys.right) player.vx = SPEED;
            else player.vx *= 0.8;

            player.vy += GRAVITY;
            player.x += player.vx;
            player.y += player.vy;

            player.grounded = false;
            for (let p of platforms) {
                if (player.x + player.w > p.x && player.x < p.x + p.w &&
                    player.y + player.h > p.y && player.y < p.y + p.h) {
                    
                    if (player.vy > 0 && player.y + player.h < p.y + p.h/2 + player.vy) {
                        player.y = p.y - player.h; player.vy = 0; player.grounded = true;
                        if (p.type === 'end') win();
                    } 
                    else if (player.vy < 0 && player.y > p.y + p.h/2 + player.vy) {
                        player.y = p.y + p.h; player.vy = 0;
                    }
                }
            }

            items.forEach(it => {
                if (!it.collected && Math.abs(player.x - it.x) < 30 && Math.abs(player.y - it.y) < 30) {
                    it.collected = true; score++; scoreEl.innerText = score;
                    CandyAudio.playCollect(); // è§¦å‘åƒåˆ°æ˜Ÿæ˜ŸéŸ³æ•ˆ
                }
            });

            cameraX = Math.max(cameraX, player.x - 200);
            distEl.innerText = Math.floor(player.x / 10);

            if (player.y > 500) endGame("æ‰è¿›å¥¶æ²¹æ± äº†ï¼ğŸ©", "åˆ«ç°å¿ƒï¼Œä¸‹æ¬¡ä¸€å®šèƒ½è·³è¿‡å»ï¼");
            if (player.x < cameraX - 100) player.x = cameraX - 100;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-cameraX, 0);

            platforms.forEach(p => {
                if (p.type === 'end') {
                    ctx.fillStyle = "#FFD1DC"; drawRoundedRect(ctx, p.x, p.y, p.w, p.h, 20);
                    ctx.font = "40px Arial"; ctx.fillText("ğŸ‚", p.x + p.w/2 - 20, p.y - 10);
                    ctx.fillStyle = "var(--candy-pink)"; ctx.font = "bold 20px Arial"; ctx.fillText("GOAL!!", p.x + 100, p.y + 45);
                } else {
                    ctx.fillStyle = p.type === 'ground' ? "#D4A373" : "#B2F7EF";
                    drawRoundedRect(ctx, p.x, p.y, p.w, p.h, 10);
                    ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.strokeRect(p.x+5, p.y+5, p.w-10, p.h-10);
                }
            });

            items.forEach(it => { if(!it.collected) ctx.fillText("â­", it.x, it.y); });

            ctx.fillStyle = "#D99FA9"; drawRoundedRect(ctx, player.x, player.y, player.w, player.h, 8);
            ctx.fillStyle = "white"; ctx.fillRect(player.x+22, player.y+8, 4, 4); ctx.fillRect(player.x+8, player.y+8, 4, 4);
            ctx.fillStyle = "#FFB6C1"; ctx.beginPath(); ctx.arc(player.x+5, player.y+18, 3, 0, 7); ctx.arc(player.x+30, player.y+18, 3, 0, 7); ctx.fill();

            ctx.restore();
        }

        function drawRoundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath(); ctx.moveTo(x+r, y); ctx.lineTo(x+w-r, y); ctx.quadraticCurveTo(x+w, y, x+w, y+r);
            ctx.lineTo(x+w, y+h-r); ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h); ctx.lineTo(x+r, y+h);
            ctx.quadraticCurveTo(x, y+h, x, y+h-r); ctx.lineTo(x, y+r); ctx.quadraticCurveTo(x, y, x+r, y);
            ctx.closePath(); ctx.fill();
        }

        function win() { 
            CandyAudio.playCollect(); // è§¦å‘èƒœåˆ©éŸ³æ•ˆ
            endGame("ç‚¹å¿ƒæ—¶é—´åˆ°ï¼ğŸ‰", `ä½ æˆåŠŸåˆ°è¾¾äº†ç»ˆç‚¹ï¼Œæ”¶é›†äº† ${score} é¢—æ˜Ÿï¼`); 
        }

        function endGame(title, desc) {
            isGameOver = true;
            CandyAudio.playGameOver(); // è§¦å‘å¤±è´¥éŸ³æ•ˆ
            modal.style.display = 'flex';
            document.getElementById('result-title').innerText = title;
            document.getElementById('result-desc').innerText = desc;
        }

        function resetGame() { 
            CandyAudio.playClick(); // ç‚¹å‡»æŒ‰é’®å£°
            init(); 
        }
        
        init();
    </script>
</body>
</html>